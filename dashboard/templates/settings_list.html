{% extends "base.html" %}
{% block title %}ì„œë²„ ì„¤ì • ëª©ë¡{% endblock %}
{% block content %}
    <h2>ì„œë²„ ì„¤ì • ëª©ë¡</h2>
    <p>ì•„ë˜ëŠ” ë´‡ì´ ì¶”ê°€ëœ ì„œë²„ ëª©ë¡ì…ë‹ˆë‹¤. ê° ì„œë²„ì˜ ì„¤ì •ì„ í¸ì§‘í•˜ë ¤ë©´ 'í¸ì§‘'ì„ í´ë¦­í•˜ì„¸ìš”.</p>
    <table>
        <thead>
            <tr>
                <th>ì„œë²„ ì´ë¦„</th> {# <-- 'ì„œë²„ ID'ì—ì„œ 'ì„œë²„ ì´ë¦„'ìœ¼ë¡œ ë³€ê²½ #}
                <th>ì„œë²„ ID</th>
                <th>ì„¤ì • ìƒíƒœ</th>
                <th>ì•¡ì…˜</th>
            </tr>
        </thead>
        <tbody>
            {% for guild in guilds %}
            <tr>
                <td>{{ guild.name }}</td> {# <-- guild.name í‘œì‹œ #}
                <td>{{ guild.id }}</td>
                <td>
                    í¸ì§‘ í•„ìš” ğŸ“
                </td>
                <td><a href="{{ url_for('edit_settings', guild_id=guild.id) }}">í¸ì§‘</a></td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4">ì €ì¥ëœ ì„œë²„ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ë´‡ì„ Discord ì„œë²„ì— ì¶”ê°€í•œ í›„, í•´ë‹¹ ì„œë²„ì—ì„œ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# ìŠˆí¼ ê´€ë¦¬ì(dashboard_admin_username)ë§Œ ë³¼ ìˆ˜ ìˆëŠ” ë´‡ ìƒíƒœ ì„¤ì • ì„¹ì…˜ #}
    {% if current_user.username == dashboard_admin_username %} {# <-- ì´ ë¶€ë¶„ ìˆ˜ì •! #}
    <h2 style="margin-top: 40px;">ë´‡ ìƒíƒœ ë° í™œë™ ì„¤ì •</h2>
    <p>ë´‡ì˜ Discord ìƒíƒœ(ì˜¨ë¼ì¸, ìë¦¬ ë¹„ì›€ ë“±)ì™€ í™œë™ ë©”ì‹œì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì´ ì„¤ì •ì€ **ì „ì—­ì **ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</p>
    <form id="botPresenceForm" method="POST" action="{{ url_for('bot_presence_api') }}"> {# actionì€ API ì—”ë“œí¬ì¸íŠ¸ #}
        <div class="form-group">
            <label for="status">ë´‡ ìƒíƒœ:</label>
            <select id="status" name="status">
                <option value="online" {% if bot_presence_settings.status == 'online' %}selected{% endif %}>ì˜¨ë¼ì¸</option>
                <option value="idle" {% if bot_presence_settings.status == 'idle' %}selected{% endif %}>ìë¦¬ ë¹„ì›€</option>
                <option value="dnd" {% if bot_presence_settings.status == 'dnd' %}selected{% endif %}>ë°©í•´ ê¸ˆì§€</option>
                <option value="invisible" {% if bot_presence_settings.status == 'invisible' %}selected{% endif %}>ì˜¤í”„ë¼ì¸ í‘œì‹œ</option>
            </select>
        </div>
        <div class="form-group">
            <label for="activity_type">í™œë™ ìœ í˜•:</label>
            <select id="activity_type" name="activity_type">
                <option value="playing" {% if bot_presence_settings.activity_type == 'playing' %}selected{% endif %}>í”Œë ˆì´ ì¤‘</option>
                <option value="streaming" {% if bot_presence_settings.activity_type == 'streaming' %}selected{% endif %}>ìŠ¤íŠ¸ë¦¬ë° ì¤‘</option>
                <option value="listening" {% if bot_presence_settings.activity_type == 'listening' %}selected{% endif %}>ë“£ëŠ” ì¤‘</option>
                <option value="watching" {% if bot_presence_settings.activity_type == 'watching' %}selected{% endif %}>ì‹œì²­ ì¤‘</option>
            </select>
        </div>
        <div class="form-group">
            <label for="activity_name">í™œë™ ë©”ì‹œì§€:</label>
            <input type="text" id="activity_name" name="activity_name" value="{{ bot_presence_settings.activity_name }}">
        </div>
        <button type="submit" class="save-button">ë´‡ ìƒíƒœ ì €ì¥</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('botPresenceForm').addEventListener('submit', async function(event) {
                event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

                const form = event.target;
                const formData = new FormData(form);
                const jsonData = {};
                formData.forEach((value, key) => {
                    jsonData[key] = value;
                });

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(jsonData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message); // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                        // ì„ íƒ ì‚¬í•­: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” UI ì—…ë°ì´íŠ¸
                    } else {
                        alert('ì˜¤ë¥˜: ' + (result.error || 'ë´‡ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨')); // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ë¬¸ì œ ë°œìƒ');
                }
            });
        });
    </script>
    {% endif %}
{% endblock %}